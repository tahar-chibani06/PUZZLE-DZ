<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PUZZLE DZ - Trésors d'Algérie</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- THÈME ALGÉRIE SOMBRE --- */
            --bg-gradient: radial-gradient(circle at center, #1a1a1a 0%, #0f2215 50%, #1a0505 100%);
            --accent-color: #009933; 
            --accent-gradient: linear-gradient(90deg, #009933, #00b33c);
            --accent-red: #D60000;
            --text-color: #ffffff;
            --glass-border: rgba(255, 255, 255, 0.15);
            --lock-color: var(--accent-color);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-color);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
            touch-action: none;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s ease;
        }
        .title-dz {
            font-size: 3rem; font-weight: 900;
            background: linear-gradient(90deg, var(--accent-color) 30%, #ffffff 50%, var(--accent-red) 70%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 4px; margin: 0;
            text-shadow: 0 5px 20px rgba(0, 153, 51, 0.3); text-align: center;
        }
        .subtitle { font-size: 0.9rem; color: #a8a8b3; margin-top: 10px; letter-spacing: 2px; text-align: center; }
        .btn-start {
            margin-top: 40px; padding: 15px 50px; font-size: 1.1rem; font-weight: 700;
            color: white; background: var(--accent-gradient); border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(0, 153, 51, 0.4);
        }
        .footer-credit {
            position: absolute; bottom: 20px; font-size: 0.7rem; color: rgba(255, 255, 255, 0.5);
            letter-spacing: 1px; text-transform: uppercase; font-weight: 700;
        }
        .footer-credit span { color: var(--accent-red); }

        /* --- JEU UI --- */
        header {
            height: 60px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border);
            z-index: 10;
        }
        .level-badge {
            background: rgba(0, 153, 51, 0.2); border: 1px solid var(--accent-color);
            padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 0.8rem; color: white;
        }
        .btn-eye {
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white;
            width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-eye:active { background: var(--accent-color); }
        .btn-eye svg { width: 20px; height: 20px; fill: white; }

        .game-area {
            flex: 1; display: flex; justify-content: center; align-items: center;
            width: 100%; position: relative;
        }

        .puzzle-board {
            display: grid; gap: 0;
            background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 50px rgba(0, 153, 51, 0.1);
            position: relative; 
        }

        .puzzle-slot {
            width: 100%; height: 100%;
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 8px 8px;
        }

        .puzzle-piece {
            width: 100%; height: 100%;
            cursor: grab;
            background-repeat: no-repeat;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.3);
            box-sizing: border-box;
            position: relative; z-index: 1;
            transition: transform 0.1s ease-out;
        }

        /* Dragging = Rouge Algérien */
        .puzzle-piece.dragging {
            z-index: 1000 !important;
            transition: none !important; 
            opacity: 0.95;
            box-shadow: 0 0 0 2px var(--accent-red), 0 0 20px rgba(214, 0, 0, 0.4) !important;
            transform: scale(1.05);
        }

        /* Locked = Vert Algérien */
        .puzzle-piece.locked {
            cursor: default !important; 
            box-shadow: none !important; 
            z-index: 0; 
        }
        
        @keyframes lockFlash {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5) sepia(1) hue-rotate(90deg) saturate(5); box-shadow: 0 0 30px var(--lock-color); }
            100% { filter: brightness(1); box-shadow: none; }
        }
        .just-locked { animation: lockFlash 0.6s ease-out; }


        /* --- MODALES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        /* Contenu Modale */
        .modal-content {
            max-width: 90%; max-height: 80%; 
            border: 1px solid var(--accent-color);
            border-radius: 12px; 
            box-shadow: 0 0 40px rgba(0, 153, 51, 0.2); 
            background: #121a15; 
            overflow: hidden; transform: scale(0.9); transition: transform 0.3s;
            display: flex; flex-direction: column; align-items: center;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-img { display: block; max-width: 100%; max-height: 70vh; object-fit: contain; }

        /* --- FENÊTRE RÉCOMPENSE --- */
        .story-container { 
            padding: 25px; text-align: center; color: white; width: 90%; max-width: 550px; 
            max-height: 90vh; overflow-y: auto; 
        }
        
        .reward-image-container {
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--accent-red);
            box-shadow: 0 0 30px rgba(214, 0, 0, 0.3);
            animation: rewardPop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes rewardPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .reward-img { width: 100%; height: auto; display: block; }

        .story-title { color: var(--accent-color); font-size: 1.4rem; margin: 10px 0; text-transform: uppercase; letter-spacing: 2px; font-weight: 900;}
        .story-location { color: #aaaaaa; font-size: 1rem; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 1px; font-weight: 700;}
        
        /* Modification : Texte non italique et plus aéré */
        .story-text { 
            font-size: 1rem; 
            line-height: 1.6; 
            color: #e0e0e0; 
            margin-bottom: 30px; 
            text-align: justify; /* Justifié pour faire plus "bloc de texte" */
        }
        
        .btn-continue {
            padding: 12px 40px; background: var(--accent-gradient); color: white;
            border: none; border-radius: 50px; font-weight: 700; font-size: 1rem; cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 153, 51, 0.4); width: 100%;
        }

        /* Btn Victoire */
        .btn-next {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 40px; background: var(--accent-gradient); color: white; border: none; border-radius: 50px;
            font-weight: 700; box-shadow: 0 5px 20px rgba(0, 153, 51, 0.5); display: none; z-index: 2000;
            animation: popIn 0.5s;
        }
        @keyframes popIn { from { transform: translateX(-50%) scale(0); } to { transform: translateX(-50%) scale(1); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="logo-container">
            <h1 class="title-dz">PUZZLE DZ</h1>
            <p class="subtitle">DÉCOUVREZ LES TRÉSORS D'ALGÉRIE</p>
        </div>
        <button class="btn-start" onclick="startGame()">JOUER</button>
        <div class="footer-credit">Created by : <span>ASSSIREM MEDIA</span></div>
    </div>

    <header id="game-header" class="hidden">
        <div class="level-badge" id="level-indicator">NIVEAU 1</div>
        <button class="btn-eye" onclick="openRefModal()">
            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
        </button>
    </header>

    <div class="game-area hidden" id="game-area">
        <div id="board" class="puzzle-board"></div>
    </div>

    <button id="btn-next" class="btn-next" onclick="openRewardModal()">NIVEAU TERMINÉ ➜</button>

    <div id="ref-modal" class="modal-overlay" onclick="closeRefModal(event)">
        <div class="modal-content">
            <img id="ref-image" class="modal-img" src="" alt="Reference">
        </div>
    </div>

    <div id="story-modal" class="modal-overlay">
        <div class="modal-content story-container">
            <h2 class="story-title" id="story-title">Titre</h2>
            <div class="story-location" id="story-location">Lieu</div>
            
            <div class="reward-image-container">
                <img id="reward-img" class="reward-img" src="" alt="Reward">
            </div>

            <div class="story-text" id="story-desc"></div>

            <button class="btn-continue" onclick="finishStoryAndNext()">NIVEAU SUIVANT ➜</button>
        </div>
    </div>

    <script>
        // --- DONNÉES DES NIVEAUX ENRICHIES (2 Paragraphes) ---
        const levelsData = [
            { 
                pieces: 12, 
                title: "CAP CARBON", 
                location: "BÉJAÏA (KABYLIE)",
                keyword: "cliff,sea,lighthouse",
                story: "Surplombant la mer Méditerranée, le Cap Carbon est l'un des sites les plus emblématiques de la côte de Béjaïa. Il est célèbre pour abriter le phare naturel le plus élevé au monde, perché à plus de 220 mètres au-dessus du niveau de la mer, offrant un panorama à couper le souffle.<br><br>Le site fait partie du Parc National de Gouraya, une réserve de biosphère protégée par l'UNESCO. C'est un lieu de prédilection pour les randonneurs qui peuvent y croiser les fameux singes magots, une espèce endémique de la région, tout en admirant les falaises abruptes plongeant dans le bleu azur."
            },
            { 
                pieces: 16, 
                title: "TASSILI N'AJJER", 
                location: "DJANET (SAHARA)",
                keyword: "sahara,rock,arch",
                story: "Le Tassili n'Ajjer est un immense plateau au sud-est de l'Algérie, véritable musée à ciel ouvert. Il abrite l'une des plus importantes collections d'art rupestre préhistorique au monde, avec plus de 15 000 dessins et gravures racontant l'évolution de la vie humaine dans le Sahara.<br><br>Au-delà de son importance historique, le site est célèbre pour ses paysages lunaires fascinants. L'érosion a sculpté le grès en « forêts de pierre », créant des arches naturelles monumentales, des canyons profonds et des formations rocheuses aux allures de citadelles perdues dans le désert."
            },
            { 
                pieces: 20, 
                title: "CANYON DE GHOUFI", 
                location: "BATNA (AURÈS)",
                keyword: "canyon,valley,village",
                story: "Surnommé le « Colorado Algérien », le Canyon de Ghoufi est une merveille géologique creusée par l'oued Abiod au cœur du massif des Aurès. Sur une longueur de plusieurs kilomètres, les falaises ocre et dorées s'élèvent de part et d'autre d'une vallée verdoyante.<br><br>Ce qui rend ce lieu unique, ce sont les villages troglodytiques berbères, aujourd'hui abandonnés, accrochés aux parois du canyon. En contrebas, une palmeraie luxuriante serpente le long de la rivière, créant un contraste saisissant entre l'aridité de la roche et la vie de l'oasis."
            },
            { 
                pieces: 24, 
                title: "TIKJDA", 
                location: "BOUIRA (DJURDJURA)",
                keyword: "mountain,snow,forest",
                story: "Située dans le Parc National du Djurdjura en Kabylie, Tikjda est une station climatique perchée à 1478 mètres d'altitude. Célèbre pour ses forêts denses de cèdres de l'Atlas millénaires, c'est un sanctuaire de biodiversité qui change de visage au fil des saisons.<br><br>En hiver, Tikjda se couvre d'un épais manteau blanc, devenant un paradis pour le ski et les sports d'hiver. En été, ses sentiers offrent des randonnées spectaculaires vers des sommets comme Lalla Khedidja, offrant des vues imprenables sur toute la chaîne montagneuse."
            },
            { 
                pieces: 30, 
                title: "OASIS DE TAGHIT", 
                location: "BÉCHAR (SAOURA)",
                keyword: "oasis,sand,dunes",
                story: "Considérée comme l'une des plus belles oasis du Sahara, Taghit est la perle de la région de la Saoura. Elle est célèbre pour son vieux ksar (village fortifié) en terre rouge qui surplombe une immense palmeraie longeant l'oued Zousfana.<br><br>Le paysage est dominé par le Grand Erg Occidental et ses dunes dorées majestueuses qui viennent mourir au pied de l'oasis. Taghit est un lieu de quiétude absolue, où l'on peut admirer des couchers de soleil inoubliables sur les dunes et découvrir des gravures rupestres néolithiques."
            },
            { 
                pieces: 35, 
                title: "GROTTES MERVEILLEUSES", 
                location: "JIJEL (CORNICHE)",
                keyword: "cave,underground,stalactite",
                story: "Nichées dans la corniche jijelienne, les Grottes Merveilleuses sont un chef-d'œuvre souterrain sculpté par l'eau sur des millions d'années. Accessibles au public, elles offrent un spectacle féérique de concrétions calcaires.<br><br>À l'intérieur, la température reste constante et fraîche. Le visiteur déambule entre des stalactites tombant du plafond et des stalagmites s'élevant du sol, formant des sculptures naturelles qui évoquent, avec un peu d'imagination, des statues, des draperies ou des animaux fantastiques, le tout mis en valeur par des jeux de lumière."
            },
            { 
                pieces: 40, 
                title: "ASSEKREM", 
                location: "TAMANRASSET (HOGGAR)",
                keyword: "volcano,mountain,sunrise",
                story: "L'Assekrem est l'un des sommets les plus emblématiques du massif volcanique du Hoggar. Célèbre pour avoir accueilli l'ermitage du Père Charles de Foucauld en 1911, c'est un lieu chargé de spiritualité et de silence.<br><br>Le site est mondialement connu pour offrir l'un des plus beaux levers et couchers de soleil sur Terre. Depuis son sommet, la vue panoramique sur les pics et aiguilles de phonolite noire qui surgissent du désert est tout simplement irréelle, donnant l'impression d'être sur une autre planète."
            },
            { 
                pieces: 48, 
                title: "MONT CHENOUA", 
                location: "TIPAZA (CÔTE CENTRALE)",
                keyword: "sea,coast,mountain",
                story: "Le Mont Chenoua est la montagne qui marque l'extrémité ouest de la plaine de la Mitidja avant de plonger directement dans la mer Méditerranée. Culminant à 905 mètres, c'est un massif boisé de chênes-lièges et de pins d'Alep, offrant une fraîcheur bienvenue.<br><br>La route côtière qui contourne le Chenoua offre des panoramas splendides sur la mer turquoise et des criques sauvages. La région est également riche en histoire, située à proximité immédiate des célèbres ruines romaines de Tipasa, classées au patrimoine mondial de l'UNESCO."
            }
        ];

        let currentLevel = 0;
        let cols = 0, rows = 0;
        let slotSize = 0;
        let currentImageUrl = "";
        
        let draggedPiece = null;
        let isDragging = false;
        let startX = 0, startY = 0;
        
        function startGame() {
            document.getElementById('splash-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('game-header').classList.remove('hidden');
                document.getElementById('game-area').classList.remove('hidden');
                loadLevel(currentLevel);
            }, 500);
        }

        window.onresize = () => { if(!document.getElementById('splash-screen').style.display) loadLevel(currentLevel); };

        // --- GESTION DES MODALES ---
        function openRefModal() {
            document.getElementById('ref-image').src = currentImageUrl;
            document.getElementById('ref-modal').classList.add('active');
        }
        function closeRefModal(e) {
            if (e.target.classList.contains('modal-overlay')) document.getElementById('ref-modal').classList.remove('active');
        }

        // --- GESTION RÉCOMPENSE ---
        function openRewardModal() {
            const data = levelsData[currentLevel];
            document.getElementById('story-title').innerText = data.title;
            document.getElementById('story-location').innerText = data.location;
            document.getElementById('reward-img').src = currentImageUrl;
            // Utilisation de innerHTML pour interpréter les balises <br>
            document.getElementById('story-desc').innerHTML = data.story;
            document.getElementById('story-modal').classList.add('active');
        }

        function finishStoryAndNext() {
            document.getElementById('story-modal').classList.remove('active');
            currentLevel++;
            loadLevel(currentLevel);
        }

        // --- CHARGEMENT NIVEAU ---
        function loadLevel(index) {
            if (index >= levelsData.length) { 
                alert("Félicitations ! Vous avez exploré toute l'Algérie !"); 
                location.reload(); 
                return; 
            }

            const data = levelsData[index];
            const board = document.getElementById('board');
            const area = document.getElementById('game-area');
            
            board.innerHTML = "";
            document.getElementById('btn-next').style.display = "none";
            document.getElementById('level-indicator').innerText = `NIVEAU ${index + 1}`;
            board.style.borderColor = "rgba(255,255,255,0.1)";

            const w = area.clientWidth;
            const h = area.clientHeight;
            const grid = calcGrid(data.pieces, w, h);
            cols = grid.cols; rows = grid.rows;

            slotSize = Math.floor(Math.min((w * 0.95) / cols, (h * 0.95) / rows));
            
            board.style.width = `${slotSize * cols}px`;
            board.style.height = `${slotSize * rows}px`;
            board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            board.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

            // Génération d'image via LoremFlickr pour la démo
            currentImageUrl = `https://loremflickr.com/${slotSize*cols}/${slotSize*rows}/${data.keyword}?random=${index}`;

            let order = Array.from({length: data.pieces}, (_, i) => i);
            order.sort(() => Math.random() - 0.5);

            for (let i = 0; i < data.pieces; i++) {
                let slot = document.createElement('div');
                slot.className = 'puzzle-slot';
                slot.dataset.idx = i; 

                const pid = order[i];
                const piece = createPiece(pid, currentImageUrl);
                slot.appendChild(piece);
                board.appendChild(slot);
                
                checkIfPieceShouldLock(piece, slot);
            }
            checkWin();
        }

        function createPiece(id, url) {
            const p = document.createElement('div');
            p.className = 'puzzle-piece';
            p.dataset.realId = id; 

            const cx = id % cols;
            const cy = Math.floor(id / cols);
            
            p.style.backgroundImage = `url(${url})`;
            p.style.backgroundSize = `${cols * 100}% ${rows * 100}%`;
            p.style.backgroundPosition = `${(cx / (cols-1))*100}% ${(cy / (rows-1))*100}%`;
            if (cols === 1) p.style.backgroundPositionX = "0%";
            if (rows === 1) p.style.backgroundPositionY = "0%";

            p.addEventListener('pointerdown', startDrag);
            return p;
        }

        // --- MOTEUR PHYSIQUE (LOCK IN PLACE) ---
        function startDrag(e) {
            e.preventDefault();
            const piece = e.target;
            if (piece.classList.contains('locked')) return;

            draggedPiece = piece;
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;

            piece.classList.add('dragging');
            piece.setPointerCapture(e.pointerId);

            document.addEventListener('pointermove', onDrag);
            document.addEventListener('pointerup', endDrag);
        }

        function onDrag(e) {
            if (!isDragging || !draggedPiece) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            draggedPiece.style.transform = `translate(${dx}px, ${dy}px)`;
        }

        function endDrag(e) {
            if (!isDragging || !draggedPiece) return;
            isDragging = false;
            
            document.removeEventListener('pointermove', onDrag);
            document.removeEventListener('pointerup', endDrag);

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            const colShift = Math.round(dx / slotSize);
            const rowShift = Math.round(dy / slotSize);
            const idxShift = (rowShift * cols) + colShift;

            draggedPiece.classList.remove('dragging');
            draggedPiece.style.transform = ''; 
            draggedPiece.releasePointerCapture(e.pointerId);

            if (colShift !== 0 || rowShift !== 0) {
                tryMovePiece(draggedPiece, colShift, idxShift);
            }
            draggedPiece = null;
        }

        function tryMovePiece(piece, cShift, iShift) {
            const oldSlot = piece.parentNode;
            const oldIdx = parseInt(oldSlot.dataset.idx);
            const newIdx = oldIdx + iShift;

            if (newIdx < 0 || newIdx >= (cols * rows)) return;
            const oldC = oldIdx % cols;
            const newC = newIdx % cols;
            if (newC !== oldC + cShift) return;

            const targetSlot = document.querySelector(`.puzzle-slot[data-idx='${newIdx}']`);
            const resident = targetSlot.children[0];

            if (resident && resident.classList.contains('locked')) return;

            if (resident) oldSlot.appendChild(resident);
            targetSlot.appendChild(piece);

            checkIfPieceShouldLock(piece, targetSlot);
            if (resident) checkIfPieceShouldLock(resident, oldSlot);
            checkWin();
        }

        function checkIfPieceShouldLock(piece, slot) {
            if (!piece || !slot) return;
            const realId = parseInt(piece.dataset.realId);
            const slotIdx = parseInt(slot.dataset.idx);

            if (realId === slotIdx) {
                if (!piece.classList.contains('locked')) {
                    piece.classList.add('locked');
                    piece.classList.add('just-locked');
                    setTimeout(() => piece.classList.remove('just-locked'), 600);
                }
            }
        }

        function calcGrid(total, w, h) {
            const ratio = w / h;
            let bestC=1, bestR=total, bestDiff=999;
            for(let c=1; c<=total; c++) {
                if(total%c===0) {
                    let r = total/c;
                    let diff = Math.abs((c/r)-ratio);
                    if(diff < bestDiff) { bestDiff=diff; bestC=c; bestR=r; }
                }
            }
            return {cols: bestC, rows: bestR};
        }

        function checkWin() {
            const total = cols * rows;
            const lockedCount = document.querySelectorAll('.puzzle-piece.locked').length;
            if (lockedCount === total && total > 0) {
                document.getElementById('board').style.borderColor = "var(--accent-color)";
                document.getElementById('btn-next').style.display = "block";
            }
        }
    </script>
</body>
</html>
