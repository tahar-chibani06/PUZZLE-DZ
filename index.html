<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PUZZLE DZ - V85 ADMIN BUILDER</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE (INCHANG√â) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; background: #000; font-family: 'Montserrat', sans-serif; color: #333; }
        
        /* ECRANS */
        .screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; flex-direction: column; background: #f4f4f4; z-index: 10; 
        }

        /* 1. ACCUEIL */
        #home { 
            display: flex; background: #000; justify-content: center; align-items: center; text-align: center; color: white; 
            z-index: 9999;
        }
        .logo-home { width: 140px; height: 140px; margin: 0 auto 20px auto; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50,10 L90,25 L90,55 Q90,85 50,110 Q10,85 10,55 L10,25 Z' fill='%2300802b' stroke='white' stroke-width='3'/%3E%3Cpath d='M50,10 V110' stroke='rgba(255,255,255,0.2)' stroke-width='2'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; }
        .btn-enter { margin-top: 50px; padding: 15px 50px; background: #000; border: 2px solid #fff; color: #fff; border-radius: 30px; font-weight: 800; font-size: 1.2rem; cursor: pointer; z-index: 100000; }

        /* 2. MENU */
        #menu { justify-content: center; align-items: center; position: relative; }
        .top-icons { position: absolute; top: 20px; right: 20px; z-index: 20; }
        .icon-btn { background: none; border: none; font-size: 1.5rem; margin-left: 10px; cursor: pointer; padding: 10px; }
        .logo-menu { width: 150px; height: 150px; margin-bottom: 40px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M30,10 L70,10 L80,30 L75,60 L50,90 L25,60 L20,30 Z' fill='%2300802b' stroke='%23333' stroke-width='2'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; }
        .main-btn { width: 70%; max-width: 280px; padding: 18px; margin: 10px 0; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .green { background: #00802b; color: white; }
        .white { background: white; color: #333; border: 1px solid #ccc; }
        .red { background: #fff5f5; color: #d60000; margin-top: 20px; font-size: 0.7rem; }

        /* 3. LIBRAIRIE */
        #lib { background: #fff; }
        .header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .score-display { background: #00802b; color: white; padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 0.8rem; }
        .ad-top { padding: 15px; flex-shrink: 0; }
        .ad-card { width: 100%; height: 120px; background: #333; border-radius: 8px; overflow: hidden; position: relative; }
        .ad-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .ad-txt { position: absolute; bottom: 10px; left: 10px; color: white; text-shadow: 0 2px 3px black; font-weight: bold; }
        .cats-wrap { overflow-x: auto; white-space: nowrap; padding: 0 15px 10px; flex-shrink: 0; }
        .cat-chip { display: inline-block; padding: 8px 16px; margin-right: 8px; border-radius: 20px; background: #f0f0f0; color: #666; font-weight: 700; font-size: 0.8rem; border: 1px solid #eee; cursor: pointer; }
        .cat-chip.selected { background: #1a1a1a; color: white; border-color: #1a1a1a; }
        .grid-wrap { flex: 1; overflow-y: auto; padding: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 50px; }
        .item { aspect-ratio: 1; background: #eee; border-radius: 10px; overflow: hidden; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .badge { position: absolute; bottom: 6px; right: 6px; background: rgba(255,255,255,0.9); padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 800; }
        .lock { position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #555; }
        .custom-area { grid-column: span 2; padding: 30px; text-align: center; border: 2px dashed #ddd; border-radius: 15px; }
        .diff-buttons { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
        .diff-btn { padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .diff-btn.selected { background: var(--dark); color: white; border-color: var(--dark); }

        /* 4. BRIEFING */
        #brief { background: #fff; }
        .brief-top { height: 50vh; background: #eee; position: relative; flex-shrink: 0; }
        .brief-img { width: 100%; height: 100%; object-fit: cover; }
        .btn-back-circle { position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }
        .brief-info { flex: 1; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; }
        .b-titre { font-size: 1.8rem; font-weight: 900; margin: 0; }
        .b-niv { color: #00802b; font-weight: 700; margin-bottom: 5px; }
        .b-desc { color: #666; font-size: 0.9rem; line-height: 1.4; margin-bottom: 20px; }
        .btn-play { margin-top: auto; padding: 18px; background: #00802b; color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 800; text-transform: uppercase; box-shadow: 0 10px 25px rgba(0,128,43,0.3); width: 100%; flex-shrink: 0; }

        /* 5. JEU */
        #game { background: #fafafa; touch-action: none; }
        .game-nav { height: 70px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .prog-wrap { flex: 1; margin: 0 15px; display: flex; flex-direction: column; justify-content: center; }
        .prog-label { font-size: 0.6rem; color: #999; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        .prog-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .prog-fill { width: 0%; height: 100%; background: #00802b; transition: width 0.3s; }
        .game-board { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; width: 100%; background: #f0f0f0; }
        .puzzle-area { position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.1); background: white; }
        .piece { position: absolute; touch-action: none; box-sizing: border-box; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6), 0 2px 4px rgba(0,0,0,0.2); border-radius: 2px; z-index: 10; transition: transform 0.1s; }
        .piece.dragging { z-index: 1000; transform: scale(1.1); box-shadow: 0 15px 30px rgba(0,0,0,0.4); border: 1px solid #fff; }
        .piece.locked { z-index: 1; pointer-events: none; box-shadow: none; border-radius: 0; border: none; filter: brightness(1.0); transition: all 0.3s ease; }
        .game-bot { height: 70px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; padding: 0 15px; flex-shrink: 0; }
        .pub-strip { width: 100%; height: 50px; background: #f8f8f8; border: 1px solid #ddd; border-radius: 6px; display: flex; align-items: center; padding: 0 10px; }
        .pub-icon { width:30px; height:30px; background:#ccc; margin-right:10px; border-radius:4px; background-size:cover; flex-shrink:0; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 30px; width: 85%; border-radius: 15px; text-align: center; }
        .inp { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin: 10px 0; font-family: monospace; }
        
        /* ADMIN PANEL (MODIFI√â POUR CREATION) */
        #panel { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: white; z-index: 500; display: none; flex-direction: column; }
        .panel-head { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background: white; flex-shrink: 0; }
        .panel-scroll { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        .panel-footer-space { height: 50px; } 
        .adm-section { margin-bottom: 30px; background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; text-align: left; }
        .adm-header { font-weight: 900; color: #00802b; margin-bottom: 15px; display: block; border-bottom: 2px solid #00802b; padding-bottom: 5px; }
        .adm-label { font-size: 0.7rem; font-weight: 700; color: #555; display: block; margin-top: 10px; }
        .action-row { display: flex; gap: 10px; align-items: stretch; margin-bottom: 15px; }
        input[type=file] { display: none; }
    </style>
</head>
<body>

    <div id="home" class="screen active">
        <div>
            <div class="logo-home"></div>
            <h1 style="font-size:3rem; margin:0; font-weight:900;">PUZZLE DZ</h1>
            <div style="color:#00802b; font-weight:700; letter-spacing:3px;">AUTHENTIC ALGERIA</div>
            <button class="btn-enter" onclick="document.getElementById('home').style.display='none'; document.getElementById('menu').style.display='flex'; setTimeout(startSystem, 50);">ENTRER</button>
        </div>
    </div>

    <div id="menu" class="screen">
        <div class="top-icons">
            <button class="icon-btn" onclick="openAdminModal()">üîí</button>
            <button class="icon-btn" onclick="alert('Version 85 - Builder Mode')">‚öôÔ∏è</button>
        </div>
        <div class="logo-menu"></div>
        <button class="main-btn green" onclick="nav('lib')">NOUVELLE PARTIE</button>
        <button class="main-btn white" onclick="resume()">REPRENDRE</button>
        <button class="main-btn red" onclick="resetAll()">R√âINITIALISER TOUT</button>
    </div>

    <div id="lib" class="screen">
        <div class="header">
            <b>PUZZLE DZ</b>
            <div class="score-display">üíé <span id="sc1">0</span></div>
        </div>
        <div class="ad-top">
            <div class="ad-card">
                <img id="ad-top-img" src="" class="ad-img">
                <div class="ad-txt" id="pub-h-txt">...</div>
            </div>
        </div>
        <div class="cats-wrap" id="cats"></div>
        <div class="grid-wrap">
            <div class="grid" id="grid"></div>
        </div>
    </div>

    <div id="brief" class="screen">
        <div class="brief-top">
            <div class="btn-back-circle" onclick="nav('lib')">‚ùÆ</div>
            <img id="brief-img" class="brief-img" src="">
        </div>
        <div class="brief-info">
            <h2 id="b-titre" style="margin:0;">TITRE</h2>
            <div id="b-niv" style="color:#00802b; font-weight:bold; margin-top:5px;">NIVEAU 1</div>
            <p id="b-desc" class="b-desc">...</p>
            <button class="btn-play" onclick="playGame()">COMMENCER LE PUZZLE</button>
        </div>
    </div>

    <div id="game" class="screen">
        <div class="game-nav">
            <button class="icon-btn" onclick="nav('lib')">‚ùÆ</button>
            <div class="prog-wrap"><div class="prog-label">PROGRESSION</div><div class="prog-bg"><div id="prog-bar" class="prog-fill"></div></div></div>
            <div style="font-weight:bold;">üíé <span id="sc2">0</span></div>
        </div>
        <div class="game-board" id="zone">
            <div id="plateau" class="puzzle-area"></div>
        </div>
        <div class="game-bot">
            <div class="pub-strip">
                <div id="ad-bot-icon" class="pub-icon"></div>
                <div><b style="font-size:0.8rem; display:block;" id="ad-bot-title">TITRE</b><span style="font-size:0.6rem; color:#777;" id="ad-bot-sub">...</span></div>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-box">
            <h3>Admin</h3>
            <input type="password" id="pass" class="inp" placeholder="Code (1234)">
            <button class="main-btn green" style="width:100%" onclick="checkPass()">OK</button>
            <button onclick="document.getElementById('modal-admin').style.display='none'" style="margin-top:10px; background:none; border:none;">Fermer</button>
        </div>
    </div>

    <div id="modal-win" class="modal">
        <div class="modal-box">
            <h2 style="color:#00802b">BRAVO !</h2>
            <p>+15 Points</p>
            <img id="win-img" src="" style="width:100%; border-radius:10px; margin-bottom:10px;">
            <button class="main-btn green" onclick="nextLvl()">CONTINUER</button>
        </div>
    </div>

    <div id="panel">
        <div class="panel-head">
            <b>ADMINISTRATION</b>
            <button class="icon-btn" onclick="document.getElementById('panel').style.display='none'">‚úï</button>
        </div>
        <div class="panel-scroll">
            <div class="adm-section">
                <span class="adm-header">1. GESTION DES PUBS</span>
                <span class="adm-label">Pub Haut (Image) :</span><input id="v1-img" class="inp">
                <span class="adm-label">Pub Haut (Titre) :</span><input id="v1-title" class="inp">
                <hr style="margin:15px 0; border:0; border-top:1px dashed #ddd;">
                <span class="adm-label">Pub Bas (Ic√¥ne) :</span><input id="v2-icon" class="inp">
                <span class="adm-label">Pub Bas (Titre) :</span><input id="v2-title" class="inp">
                <span class="adm-label">Pub Bas (Sous-titre) :</span><input id="v2-sub" class="inp">
            </div>

            <div class="adm-section">
                <span class="adm-header">2. CR√âER TES CAT√âGORIES</span>
                <div class="action-row">
                    <select id="sel-cat" class="inp" style="flex:1; margin:0;" onchange="loadCatEdit()"></select>
                    <button class="main-btn green" style="width:auto; padding:0 15px; margin:0; font-size:1.2rem;" onclick="addCat()">+</button>
                    <button class="main-btn red" style="width:auto; padding:0 15px; margin:0; font-size:1.2rem;" onclick="delCat()">üóëÔ∏è</button>
                </div>
                
                <div style="background:white; padding:15px; border-radius:8px; border:1px solid #ddd;">
                    <span class="adm-label">Nom de la cat√©gorie :</span>
                    <input id="v3-name" class="inp" placeholder="Ex: Mes Voitures">
                    
                    <span class="adm-label">Lien Image ou Mot-cl√© :</span>
                    <input id="v3-key" class="inp" placeholder="Ex: algeria OU https://mon-site.com/img.jpg">
                    <small style="color:#777; font-size:0.7rem;">Si c'est un lien direct (http...), l'image sera fixe. Si c'est un mot, images al√©atoires.</small>
                    
                    <span class="adm-label">Description de pr√©sentation :</span>
                    <textarea id="v3-desc" class="inp" rows="3" placeholder="Texte affich√© avant le puzzle..."></textarea>
                    
                    <button class="main-btn green" style="width:100%; padding:10px; margin-top:10px;" onclick="applyCatUpdate()">VALIDER LES MODIFICATIONS</button>
                </div>
            </div>

            <button class="main-btn green" style="width:100%; margin-bottom:10px;" onclick="saveAll()">üíæ SAUVEGARDER TOUT</button>
            <button class="main-btn red" style="width:100%" onclick="resetFactory()">‚ö†Ô∏è RESET USINE</button>
            <div class="panel-footer-space"></div>
        </div>
    </div>

    <input type="file" id="file" onchange="fileUp(event)">

    <script>
        // --- DONNEES MINIMALISTES ---
        // On ne garde que "custom" pour que le syst√®me marche. Le reste est vide.
        var defCats = [
            {id:'custom', n:'üì∏ Perso', k:'', d:'Importez vos propres photos depuis la galerie.'}
        ];
        
        var defAds = {
            top: { img: 'https://via.placeholder.com/600x300', t: 'Votre Pub Ici' },
            bot: { icon: 'https://via.placeholder.com/100', t: 'Titre Pub', s: 'Sous-titre' }
        };

        var cats = JSON.parse(JSON.stringify(defCats));
        var ads = JSON.parse(JSON.stringify(defAds));
        var score=0, cat='custom', lvl=0, imgUrl="", customPieces=24;

        // --- SYSTEME ---
        function startSystem() {
            try {
                var sCats = localStorage.getItem('pz_cats_v85'); // Nouvelle cl√© v85
                if(sCats) cats = JSON.parse(sCats);
                var sAds = localStorage.getItem('pz_ads_v85');
                if(sAds) ads = JSON.parse(sAds);
                var sSc = localStorage.getItem('pz_score');
                if(sSc) score = parseInt(sSc);
            } catch(e){}
            updateScore();
            drawTabs();
            applyAds();
        }

        function nav(id) {
            var ss = document.querySelectorAll('.screen');
            for(var i=0; i<ss.length; i++) if(ss[i].id!=='panel') ss[i].style.display='none';
            document.getElementById(id).style.display='flex';
            if(id==='lib') drawGrid();
        }

        function updateScore() {
            document.getElementById('sc1').innerText = score;
            document.getElementById('sc2').innerText = score;
        }

        function applyAds() {
            document.getElementById('ad-top-img').src = ads.top.img;
            document.getElementById('pub-h-txt').innerText = ads.top.t;
            document.getElementById('ad-bot-icon').style.backgroundImage = 'url('+ads.bot.icon+')';
            document.getElementById('ad-bot-title').innerText = ads.bot.t;
            document.getElementById('ad-bot-sub').innerText = ads.bot.s;
        }

        // --- LIBRAIRIE ---
        function drawTabs() {
            var c = document.getElementById('cats'); c.innerHTML = '';
            // Si aucune cat (bug), on remet custom
            if(cats.length === 0) cats = JSON.parse(JSON.stringify(defCats));
            
            cats.forEach(function(x){
                var b = document.createElement('button');
                b.className = 'cat-chip' + (x.id===cat ? ' selected' : '');
                b.innerText = x.n;
                b.onclick = function(){ cat=x.id; drawTabs(); drawGrid(); };
                c.appendChild(b);
            });
            // Si la cat active n'existe plus, on switch sur la premi√®re
            if(!cats.find(function(x){return x.id===cat})) {
                cat = cats[0].id;
                drawTabs(); // Redessine avec la bonne selection
            }
        }

        function drawGrid() {
            var g = document.getElementById('grid'); g.innerHTML = '';
            
            // Mode Perso Sp√©cial
            if(cat === 'custom') {
                g.innerHTML = `<div class="custom-area"><div style="font-size:3rem">üì∏</div><b>Importez votre photo</b><div class="diff-buttons"><button class="diff-btn" onclick="customPieces=24;drawGrid()">Facile</button><button class="diff-btn" onclick="customPieces=32;drawGrid()">Moyen</button></div><button class="main-btn green" onclick="document.getElementById(\'file\').click()">CHOISIR</button></div>`;
                return;
            }

            // Cat√©gories Cr√©√©es par l'User
            var currentCatObj = cats.find(function(x){return x.id===cat});
            if(!currentCatObj) return;

            var max = 0; try { max = parseInt(localStorage.getItem('pz_prog_'+cat)) || 0; } catch(e){}
            var k = currentCatObj.k; // Le lien ou mot cl√©

            for(var i=0; i<20; i++) {
                var d=document.createElement('div'); d.className='item';
                
                // Logique URL : Si commence par http, c'est un lien direct (fixe). Sinon c'est un mot cl√© LoremFlickr.
                var u = (k.indexOf('http')===0) ? k : 'https://loremflickr.com/320/320/'+k+'?lock='+i;
                
                var lk = i > max;
                d.innerHTML='<img src="'+u+'" onerror="this.src=\'https://via.placeholder.com/300?text=Image\'">' + (lk?'<div class="lock">üîí</div>':'<div class="badge">Niv '+(i+1)+'</div>');
                if(!lk) (function(url, idx){ d.onclick=function(){ openBrief(url, idx); } })(u, i);
                g.appendChild(d);
            }
        }

        function openBrief(u, i) {
            imgUrl = u; lvl = i;
            document.getElementById('brief-img').src = u;
            var cObj = cats.find(function(x){return x.id===cat});
            document.getElementById('b-titre').innerText = cObj.n.toUpperCase();
            document.getElementById('b-niv').innerText = 'NIVEAU ' + (i+1);
            document.getElementById('b-desc').innerText = cObj.d || "";
            nav('brief');
        }

        // --- JEU (INCHANG√â & STABLE) ---
        function playGame() {
            var saveState = { cat: cat, lvl: lvl, img: imgUrl, nb: (cat==='custom' ? customPieces : 24) };
            localStorage.setItem('pz_last', JSON.stringify(saveState));
            nav('game');
            document.getElementById('prog-bar').style.width = '0%';
            setTimeout(createBoard, 300);
        }

        function resume() { 
            try {
                var l = JSON.parse(localStorage.getItem('pz_last')); 
                if(l) {
                    cat = l.cat; lvl = l.lvl; imgUrl = l.img;
                    if(l.nb) customPieces = l.nb;
                    playGame();
                } else { alert("Aucune partie trouv√©e."); }
            } catch(e) { console.log(e); } 
        }

        function createBoard() {
            var z = document.getElementById('zone'); 
            var p = document.getElementById('plateau'); 
            p.innerHTML = '';
            var wAvailable = z.clientWidth - 20; 
            var hAvailable = z.clientHeight - 20;
            if(wAvailable < 100) wAvailable = window.innerWidth - 20;
            var nbPieces = (cat==='custom') ? customPieces : 24;
            var cols = 4; var rows = Math.ceil(nbPieces / cols);
            var size = Math.floor(Math.min(wAvailable/cols, hAvailable/rows));
            p.style.width = (size*cols)+'px'; p.style.height = (size*rows)+'px';
            var ids=[]; for(var k=0; k<nbPieces; k++) ids.push(k);
            var posInit = []; for(var k=0; k<nbPieces; k++) posInit.push(k);
            posInit.sort(function(){return 0.5-Math.random()});
            for(var i=0; i<nbPieces; i++) {
                var div=document.createElement('div'); div.className='piece';
                div.style.width=size+'px'; div.style.height=size+'px';
                div.style.backgroundImage='url('+imgUrl+')';
                div.style.backgroundSize=(size*cols)+'px '+(size*rows)+'px';
                var pid=ids[i]; var cx=pid%cols; var cy=Math.floor(pid/cols);
                div.style.backgroundPosition='-'+(cx*size)+'px -'+(cy*size)+'px';
                div.dataset.tx = cx*size; div.dataset.ty = cy*size;
                var rand=posInit[i];
                div.style.left=(rand%cols)*size+'px'; div.style.top=Math.floor(rand/cols)*size+'px';
                div.addEventListener('touchstart', dragStart, {passive:false});
                div.addEventListener('mousedown', dragStart);
                p.appendChild(div);
            }
        }
        var dragged=null, startX, startY, oL, oT;
        function dragStart(e) {
            if(e.target.classList.contains('locked')) return;
            e.preventDefault(); 
            dragged=e.target; dragged.classList.add('dragging');
            var pt=e.touches?e.touches[0]:e; startX=pt.clientX; startY=pt.clientY;
            oL=parseInt(dragged.style.left); oT=parseInt(dragged.style.top);
            if(e.type=='touchstart') { window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end); }
            else { window.addEventListener('mousemove', move); window.addEventListener('mouseup', end); }
        }
        function move(e) {
            if(!dragged) return; e.preventDefault();
            var pt=e.touches?e.touches[0]:e;
            dragged.style.transform = 'translate('+(pt.clientX-startX)+'px, '+(pt.clientY-startY)+'px)';
        }
        function end(e) {
            if(!dragged) return;
            window.removeEventListener('touchmove', move); window.removeEventListener('touchend', end);
            window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', end);
            dragged.classList.remove('dragging');
            var pt=e.changedTouches?e.changedTouches[0]:e;
            var finalL=oL+(pt.clientX-startX); var finalT=oT+(pt.clientY-startY);
            var targetL=parseInt(dragged.dataset.tx); var targetT=parseInt(dragged.dataset.ty);
            dragged.style.transform = 'none';
            if(Math.hypot(finalL-targetL, finalT-targetT) < 40) { dragged.style.left=targetL+'px'; dragged.style.top=targetT+'px'; dragged.classList.add('locked'); } 
            else { dragged.style.left=finalL+'px'; dragged.style.top=finalT+'px'; }
            dragged=null; checkWin();
        }
        function checkWin() {
            var all = document.querySelectorAll('.piece');
            var locked = document.querySelectorAll('.piece.locked');
            document.getElementById('prog-bar').style.width = ((locked.length/all.length)*100) + '%';
            if(locked.length === all.length && all.length > 0) {
                score+=15; try{localStorage.setItem('pz_score',score)}catch(e){}
                updateScore();
                try{var max=parseInt(localStorage.getItem('pz_prog_'+cat))||0; if(lvl==max) localStorage.setItem('pz_prog_'+cat, max+1);}catch(e){}
                document.getElementById('win-img').src=imgUrl;
                document.getElementById('modal-win').style.display='flex';
            }
        }
        function fileUp(e) { var fr=new FileReader(); fr.onload=function(ev){openBrief(ev.target.result,0)}; fr.readAsDataURL(e.target.files[0]); }
        function resetAll() { if(confirm('S√ªr ?')){localStorage.clear();location.reload();} }
        function nextLvl() { document.getElementById('modal-win').style.display='none'; nav('lib'); }

        // --- ADMIN AVANCE ---
        function openAdminModal() { document.getElementById('modal-admin').style.display='flex'; }
        function checkPass() { if(document.getElementById('pass').value=='1234'){document.getElementById('modal-admin').style.display='none'; initAdminPanel(); document.getElementById('panel').style.display='flex';} }
        
        function initAdminPanel() {
            // Pubs
            document.getElementById('v1-img').value = ads.top.img;
            document.getElementById('v1-title').value = ads.top.t;
            document.getElementById('v2-icon').value = ads.bot.icon;
            document.getElementById('v2-title').value = ads.bot.t;
            document.getElementById('v2-sub').value = ads.bot.s;
            
            // Liste des cat√©gories
            refreshCatSelect();
            loadCatEdit();
        }

        function refreshCatSelect() {
            var sel = document.getElementById('sel-cat'); sel.innerHTML = '';
            cats.forEach(function(c, i){
                var opt = document.createElement('option');
                opt.value = i; 
                opt.innerText = c.n + (c.id==='custom' ? ' (Syst√®me)' : ''); 
                sel.appendChild(opt);
            });
        }

        function loadCatEdit() {
            var idx = document.getElementById('sel-cat').value;
            if(!cats[idx]) return;
            document.getElementById('v3-name').value = cats[idx].n;
            document.getElementById('v3-key').value = cats[idx].k;
            document.getElementById('v3-desc').value = cats[idx].d || "";
        }

        // Ajouter une cat√©gorie vide
        function addCat() {
            var newId = 'cat_' + new Date().getTime();
            cats.push({
                id: newId,
                n: 'Nouvelle Cat√©gorie',
                k: 'nature', // D√©faut
                d: 'Description ici...'
            });
            refreshCatSelect();
            // S√©lectionner la nouvelle
            document.getElementById('sel-cat').value = cats.length - 1;
            loadCatEdit();
        }

        // Supprimer la cat√©gorie s√©lectionn√©e
        function delCat() {
            var idx = document.getElementById('sel-cat').value;
            if(cats[idx].id === 'custom') {
                alert("Impossible de supprimer la cat√©gorie 'Perso'. C'est une cat√©gorie syst√®me.");
                return;
            }
            if(confirm("Supprimer d√©finitivement la cat√©gorie : " + cats[idx].n + " ?")) {
                cats.splice(idx, 1);
                refreshCatSelect();
                loadCatEdit();
            }
        }

        function applyCatUpdate() {
            var idx = document.getElementById('sel-cat').value;
            cats[idx].n = document.getElementById('v3-name').value;
            cats[idx].k = document.getElementById('v3-key').value;
            cats[idx].d = document.getElementById('v3-desc').value;
            refreshCatSelect(); // Update le nom dans la liste
            document.getElementById('sel-cat').value = idx; // Rester dessus
            alert("Modifications appliqu√©es (Pensez √† sauvegarder !)");
        }

        function saveAll() {
            ads.top.img = document.getElementById('v1-img').value;
            ads.top.t = document.getElementById('v1-title').value;
            ads.bot.icon = document.getElementById('v2-icon').value;
            ads.bot.t = document.getElementById('v2-title').value;
            ads.bot.s = document.getElementById('v2-sub').value;
            
            localStorage.setItem('pz_ads_v85', JSON.stringify(ads));
            localStorage.setItem('pz_cats_v85', JSON.stringify(cats));
            alert("Tout est sauvegard√© !");
            location.reload();
        }

        function resetFactory() {
            if(confirm("Tout effacer et revenir √† z√©ro ?")) {
                localStorage.removeItem('pz_ads_v85');
                localStorage.removeItem('pz_cats_v85');
                location.reload();
            }
        }
    </script>
</body>
</html>
